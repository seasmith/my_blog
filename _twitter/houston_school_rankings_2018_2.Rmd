---
title: ""
author: "Luke Smith"
date: "`r Sys.Date()`"
tags: [houston, schools]
description: ""
twitter :
  card    : "summary_large_image"
  site    : "@lksmth"
  creator : "@lksmth"
  title   : ""
  description : ""
  image       : "https://seasmith.github.io/blog/houston_school_report_2018/figure-html/plot_race.png"
og :
  image : "https://seasmith.github.io/blog/houston_school_report_2018/figure-html/plot_race.png"
---

```{r knitr-opts, echo=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo=FALSE)
knitr::opts_chunk$set(warning=FALSE)
knitr::opts_chunk$set(message=FALSE)
knitr::opts_chunk$set(eval=FALSE)
```

```{r load-deps}
library(tidyverse)
library(jsonlite)
library(extrafont); loadfonts("win", TRUE)
library(magick)
library(plotly)
library(ggrepel)
library(grid)
library(lemon)
```

```{r create-imgs-folder}
if (dir.exists("houston_school_report_2018/figure-html"))
```


```{r import-from-JSON}
# http://projects.houstonchronicle.com/schoolreportcard/
# https://www.houstonchronicle.com/local/education/schoolreportcard/

sch <- fromJSON("~/R/my_blog/_twitter/reportcard/schools.json") %>% as_tibble()
dis <- fromJSON("~/R/my_blog/_twitter/reportcard/districts.json") %>% as_tibble()
```

```{r plot-variables}
grade_order <- c(
  paste0(unlist(lapply(LETTERS[1:4], rep, 3)), c("+", "", "-")),
  "F", 
  NA)

race_labels <- c(
  percentwhite = "% White",
  percentasian = "% Asian",
  percenttwo   = "% Two Races",
  percentpacisl = "% Pacific Islander",
  percentamindian = "% American Indian",
  percenthispanic = "% Hispanic",
  percentafam = "% Black"
)

```

```{r aggregated}
sch <- sch %>%
  separate(rank, c("rank", "rank_pop")) %>%
  separate(rank2017, c("rank2017", "rank2017_pop")) %>%
  separate(rank2016, c("rank2016", "rank2016_pop")) %>%
  separate(rank2015, c("rank2015", "rank2015_pop")) %>%
  mutate_at(vars(starts_with("rank"), -contains("_pop")), as.integer) %>%
  mutate(movement = rank - rank2017) %>%
  mutate_at(vars(starts_with("percent")), str_replace, "%", "") %>%
  mutate_at(vars(starts_with("percent")), as.double) %>%
  mutate(sat = str_remove(sat, " \\(.*"),
         sat = as.integer(sat),
         act = str_remove(act, " \\(.*"),
         act = as.integer(act),
         grade = factor(grade, grade_order, ordered = TRUE))
```

```{r quantize-grades}
minus_1 <- function(x) x - 1L

quant_grades <- sch %>%
    transmute_at(vars(grade:grade2015), factor, levels = rev(grade_order), ordered = TRUE) %>%
    transmute_all(as.integer) %>%
    transmute_all(minus_1)

names(quant_grades) <- paste0("q_", names(quant_grades))

sch <- sch %>%
  bind_cols(quant_grades)
```

```{r summarize}
sch_sum <- sch %>%
  group_by(district) %>%
  summarize_at(vars(q_grade:q_grade2015, sat, act), mean, na.rm = TRUE) %>%
  mutate_at(vars(q_grade:q_grade2015), round) %>%
  mutate_at(vars(q_grade:q_grade2015), as.integer) %>%
  arrange(desc(q_grade))

sch_sum2 <- sch %>%
  group_by(district) %>%
  summarize_at(vars(enrollment), sum, na.rm = TRUE)
```

```{r districts}
districts <- sch %>%
  group_by(district) %>%
  summarize_at(vars(q_grade:q_grade2015, sat, act), mean, na.rm = TRUE) %>%
  arrange(desc(q_grade)) %>%
  inner_join(sch_sum2, by = "district") %>%
  arrange(desc(enrollment))
```

```{r}
sch_by_race <- sch %>%
  filter(level == "High school") %>%
  select(campus, sat, act, percentafam:percentwhite) %>%
  gather(... = -c(sat, act, campus)) %>%
  left_join(sch %>% select(campus, enrollment), by = "campus") %>%
  mutate(new_enrollment = (value * enrollment) / 100)

scores_by_race <- sch_by_race %>%
  group_by(key) %>%
  summarize(tot_enrollment = sum(new_enrollment),
            sat = sum(sat * (new_enrollment / tot_enrollment), na.rm = TRUE),
            act = sum(act * (new_enrollment / tot_enrollment), na.rm = TRUE)) %>%
  arrange(desc(sat))

scores_order <- scores_by_race$key

sch_by_race <- sch_by_race %>%
  mutate(key = factor(key, levels = scores_order, ordered = TRUE))

scores_by_race <- scores_by_race %>%
  mutate(key = factor(key, levels = scores_order, ordered = TRUE))
```

```{r, dpi=300, fig.height=7, fig.width=7, eval=FALSE}
plot_race <- sch_by_race %>%
  ggplot(aes(value, sat)) +
  geom_hline(yintercept = 1369, color = "gray50") +
  geom_point(aes(size = new_enrollment), 
             pch = 21, color = "gray40", fill = "gray25", alpha = 0.25) +
  geom_smooth(method = "lm", se = FALSE, color = "coral", size = 0.7) +
  scale_size_area("Enrollment Size by Race", max_size = 6, labels = scales::comma) +
  scale_x_continuous(NULL, labels = function(x) paste0(x, "%"),
                     breaks = scales::pretty_breaks(4)) +
  scale_y_continuous(NULL) +
  facet_wrap(vars(key), scales = "free_x", labeller = labeller(key = race_labels)) +
  labs(title = "Houston Area Student Performance",
       subtitle = "SAT Score (School Average) and Racial Composition",
       caption = "Source: Children At Risk (2018 School Ranking)") +
  guides(size = guide_legend(title.position = "top")) +
  theme_classic(base_size = 10, base_family = "Lato") +
  theme(strip.background = element_blank(),
        strip.text = element_text("Lato"),
        legend.position = c(0.675, 0.245),
        legend.direction = "horizontal",
        legend.title = element_text(hjust = 0.5),
        legend.background = element_rect(color = "gray30"),
        plot.caption = element_text(color = "gray50"))
```


```{r plot_race, eval=FALSE}
ggsave("plot_race.png", plot_race, width = 5, height = 8, dpi = 800)
# ggsave("plot_race.svg", plot_race, width = 5, height = 8, dpi = 300)

image_read("plot_race.png") %>%
  image_resize("1344x")
```


```{r}
# totals <- function(x, y) {
#   x <- enquo(x)
#   y <- enquo(y)
#   
#     set_names(list(quo((!!x / 100) * !!y)), str_remove(quo_text(x), "percent"))
# }

students <- sch %>%
    filter(district %in% top_20_names) %>%
    select(campus, district, enrollment:percentwhite, grade) %>%
    mutate(afam = (percentafam / 100) * enrollment,
           amindian = (percentamindian / 100) * enrollment,
           asian = (percentasian / 100) * enrollment,
           hispanic = (percenthispanic / 100) * enrollment,
           pacisl = (percentpacisl / 100) * enrollment,
           two = (percenttwo / 100) * enrollment,
           white = (percentwhite / 100) * enrollment) %>%
    group_by(district) %>%
    mutate(enrollment_pct = enrollment / sum(enrollment, na.rm = TRUE)) %>%
    group_by(district, grade) %>%
    summarize(enrollment_pct = sum(enrollment_pct, na.rm = TRUE),
              enrollment = sum(enrollment, na.rm = TRUE),
              afam = sum(afam),
              amindian = sum(amindian),
              asian = sum(asian),
              hispanic = sum(hispanic),
              pacisl = sum(pacisl),
              two = sum(two),
              white = sum(white),
              percentafam = afam / sum(enrollment),
              percentamindian = amindian / sum(enrollment),
              percentasian = asian / sum(enrollment),
              percenthispanic = hispanic / sum(enrollment),
              percentpacisl = pacisl / sum(enrollment),
              percenttwo = two / sum(enrollment),
              percentwhite = white / sum(enrollment)) 

race_order <- c("percentwhite", "percentasian", "percenttwo", "percentamindian",
                "percentpacisl", "percentafam", "percenthispanic")

# PER DISTRICT HEAT MAP
students %>%
  select(district, grade, percentafam:percentwhite) %>%
  gather(... = -c(district, grade)) %>%
  mutate(key = factor(key, rev(race_order), ordered = TRUE)) %>%
  ggplot(aes(grade, value)) +
  geom_col(aes(fill = key), position = "fill", width = 1) +
  scale_y_continuous(NULL, expand = expand_scale(), sec.axis = dup_axis()
                     # breaks = c(0, 1), labels = scales::percent
  ) +
  scale_x_discrete(NULL, expand = expand_scale()) +
  scale_fill_brewer(type = "qual") +
  coord_flip() +
  guides(fill = guide_legend(nrow = 1)) +
  facet_wrap(vars(district)) +
  theme_classic(base_size = 8, base_family = "Lato") +
  theme(strip.background = element_blank(),
        strip.text = element_text("Lato"),
        legend.position = "top",
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        axis.text.x.top = element_blank(),
        axis.text.x.bottom = element_blank(),
        legend.title = element_text(hjust = 0.5),
        plot.caption = element_text(color = "gray50"))


students2 <- students %>%
    group_by(grade) %>%
    summarize(enrollment = sum(enrollment),
              afam = sum(afam),
              amindian = sum(amindian),
              asian = sum(asian),
              hispanic = sum(hispanic),
              pacisl = sum(pacisl),
              two = sum(two),
              white = sum(white),
              e_percentafam = afam / enrollment,
              e_percentamindian = amindian / enrollment,
              e_percentasian = asian / enrollment,
              e_percenthispanic = hispanic / enrollment,
              e_percentpacisl = pacisl / enrollment,
              e_percenttwo = two / enrollment,
              e_percentwhite = white / enrollment) %>%
  mutate(percentafam = afam / sum(afam),
         percentamindian = amindian / sum(amindian),
         percentasian = asian / sum(asian),
         percenthispanic = hispanic / sum(hispanic),
         percentpacisl = pacisl / sum(pacisl),
         percenttwo = two / sum(two),
         percentwhite = white / sum(white))

students2 %>%
  select(grade, percentafam:percentwhite) %>%
  split(as.integer(.$grade) > 6) %>%
  map(~summarize_at(.x, vars(percentafam:percentwhite), sum))

# STUDENT VS GRADE HEAT MAP
students2 %>%
  select(grade, percentafam:percentwhite) %>%
  gather(... = -grade) %>%
  mutate(key = factor(key, rev(race_order), ordered = TRUE)) %>%
  ggplot(aes(key, value, fill = grade)) +
  geom_col(position = "fill", width = 1) +
  coord_flip() +
  scale_y_continuous(NULL, expand = expand_scale(), sec.axis = dup_axis()
                     # breaks = c(0, 1), labels = scales::percent
  ) +
  scale_x_discrete(NULL, expand = expand_scale()) +
  scale_fill_manual(values = pals::coolwarm(15)[-(7:8)]) +
  # scale_fill_viridis_d(direction = -1) +
  theme_classic(base_size = 8, base_family = "Lato") +
  theme(strip.background = element_blank(),
        strip.text = element_text("Lato"),
        legend.position = "top",
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        axis.text.x.top = element_blank(),
        axis.text.x.bottom = element_blank(),
        legend.title = element_text(hjust = 0.5),
        plot.caption = element_text(color = "gray50"))

students %>%
  select(district, grade, percentafam:percentwhite) %>%
  gather(... = -c(district, grade)) %>%
  mutate(key = factor(key, rev(race_order), ordered = TRUE)) %>%
  filter(district == "Houston ISD") %>%
  ggplot(aes(factor(grade, rev(grade_order), ordered = TRUE), value)) +
  geom_point(aes(color = key)) +
  geom_smooth(method = "lm") +
  scale_color_manual(values = c("steelblue4", "orange2", "steelblue4", "orange2", "steelblue4", "orange2", "steelblue4"),
                     guide = FALSE) +
  facet_wrap(vars(key), nrow = 1) +
  theme_classic(base_size = 8, base_family = "Lato") +
  theme(strip.background = element_blank(),
        strip.text = element_text("Lato"),
        legend.position = "top",
        # axis.line = element_blank(),
        axis.ticks = element_blank(),
        # axis.text.x.top = element_blank(),
        # axis.text.x.bottom = element_blank(),
        legend.title = element_text(hjust = 0.5),
        plot.caption = element_text(color = "gray50"))


srd <- students %>%
  select(district, grade, percentafam:percentwhite) %>%
  gather(... = -c(district, grade)) %>%
  mutate(key = factor(key, rev(race_order), ordered = TRUE)) %>%
  filter(district %in% top_20_names) %>%
  map(~{
    ggplot(.x, aes(factor(grade, rev(grade_order), ordered = TRUE), value)) +
      geom_point(aes(color = key)) +
      geom_smooth(method = "lm") +
      scale_color_manual(values = c("steelblue4", "orange2", "steelblue4", "orange2", "steelblue4", "orange2", "steelblue4"),
                         guide = FALSE) +
      facet_wrap(vars(key), nrow = 1) +
      theme_classic(base_size = 8, base_family = "Lato") +
      theme(strip.background = element_blank(),
            strip.text = element_text("Lato"),
            legend.position = "top",
            axis.ticks = element_blank(),
            legend.title = element_text(hjust = 0.5),
            plot.caption = element_text(color = "gray50"))
  })
    


```
SAT performance in Houston has a peculiar correlation with racial groups.

Schools that have higher enrollment rates of whites, asians, and students of two races tend to have higher average SAT scores.

There is a strong negative trend in SAT performance among schools with higher enrollment rates of hispanics and blacks.

![](figure-html/plot_race_annotated.png)
