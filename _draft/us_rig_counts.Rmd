---
title  : "US Rig Counts"
author : "Luke Smith"
date   : "2017-10-06"
tags   : [r, oil, gas, oil and gas, rig counts]
description: ""
twitter :
  card    : "summary_large_image"
  site    : "@lksmth"
  creator : "@lksmth"
  title   : "US Rig Counts"
  description : ""
  image       : ""
og :
  image : ""
---

```{r setup_std, include=FALSE, purl=FALSE, eval=TRUE}
# ____ Library_Tidyverse_Setup
library(tidyverse)
library(lubridate)
library(forcats)
library(stringi)

# ____ Library_ploting_Setup
library(grid)
library(gridExtra)
library(ggExtra)
library(GGally)
library(ggalt)
library(scales)
library(extrafont)
loadfonts("win")

# ____ Library_Web_Setup
library(rvest)
library(jsonlite)

# ____ Library_Reporting_Setup
library(knitr)
library(kableExtra)

# ____ My_Blogging_Setup
library(blg)

# ____ Opts_Setup
knitr::opts_chunk$set(echo =  FALSE)
knitr::opts_chunk$set(fig.height = 7)
knitr::opts_chunk$set(message    = FALSE)
knitr::opts_chunk$set(warning    = FALSE)


# ____ R_Options_Setup
old_scipen <- getOption("scipen")
options(scipen = 100)

old_digits <- getOption("digits")
options(digits = 2)


# ____ knitr_Options_Setup
orig_inline <- knit_hooks$get("inline")
old_plot   <- knit_hooks$get("plot")


# ____ Hooks_Setup

knit_hooks$set(inline = function(x) {
  if (is.numeric(x) | is.integer(x)) return(formatC(x, format = "d", big.mark = ",")) else
    if (is.character(x)) return(stringr::str_to_title(x)) else
      return(x)
})

old_inline <- knit_hooks$get("inline")

my_blue   <- "#0059B3"
my_orange <- "#B35A00"
my_pink   <- "#B30059"
my_green  <- "#59B300"
```

```{r setup_extra, include=FALSE}
library(sf)
library(forcats)
library(httr)
library(curl)
library(zeallot)
library(kableExtra)

theme_set(blg_theme_default())
ref <- "~/R/misc/oil/US/rig_counts"

# Rig Type Colors
blue   <- "#5b63fe"
# yellow <- "#fef65b"
yellow <- "#b1ac3f"
# yellow <- "#f9ba22"
# pink   <- "#f65bfe"
pink <- "#ac3fb1"

get_2_colors <- function(x) {
  x <- Filter(function(i) i != 0, x)
  map_chr(as.character(x), ~switch(.x,
                                   "-1" = "#a52a2a",
                                   "1"  = "#4682b4"))
}
```

<!-- Rig count notes -->

```{r notes_rig_count, include=FALSE, eval=FALSE}
# Earliest splits by:
#   * Basin      = 2011
#   * State      = 2000
#   * Oil & Gas  = 1987
#   * Trajectory = 1991
#   * GOM        = 2000
#   * Canada (Province)  = 2003
#   * Canada (Oil & Gas) = 2000

# Basin names in rig counts:
# Order        Basin_Name
#     1  Ardmore Woodford
#     2   Arkoma Woodford
#     3           Barnett
#     4     Cana Woodford
#     5       DJ-Niobrara
#     6        Eagle Ford
#     7      Fayetteville
#     8      Granite Wash
#     9       Haynesville
#    10         Marcellus
#    11     Mississippian
#    12           Permian
#    13             Utica
#    14         Williston
#    15            Others
#    16 Total US RigCount
```

```{r load_data, include=FALSE, purl=TRUE}
ref <- "~/R/misc/oil/US/rig_counts"
load(file.path(ref, "rc_basin.RData"))
load(file.path(ref, "rc_master.RData"))
```

```{r analyze_data_rig_counts, include=FALSE}
nms <- c("this_week", "week_ago",
         "month_ago", "six_months_ago",
         "year_ago")

key_dates <- rc_basin$Date %>%
  unique() %>%
  sort(decreasing = TRUE) %>%
  .[c(1, 2, 5, 27, 53)] %>%
  set_names(nms)

# Find most recent week's change from previous week; Total
total_comparison <- rc_basin %>%
  group_by(basin, key) %>%
  arrange(Date) %>%
  mutate(change_1wk   = value - lag(value, 1L),
         percent_1wk  = change_1wk / lag(value),
         change_4wk   = value - lag(value, 4L),
         percent_4wk  = change_4wk / lag(value, 4),
         change_16wk  = value - lag(value, 16L),
         percent_16wk = change_16wk / lag(value, 16),
         change_52wk  = value - lag(value, 52L),
         percent_52wk = change_52wk / lag(value, 52)) %>%
  ungroup() %>%
  filter(Date %in% c(key_dates[c("this_week", "week_ago")]))

# Find most recent week's oil and gas type
type_comparison <- total_comparison %>%
  filter(Date == max(Date)) %>%
  filter(key %in% c("Gas", "Oil")) %>%
  select(basin:value) %>%
  spread(key, value) %>%
  mutate(prcnt_oil = Oil / (Oil + Gas))

# Get totals and just the current week.
# Remove NaN's and NA's for plotting purposes.
this_week <- total_comparison %>%
  filter(Date == key_dates[["this_week"]]) %>%
  filter(key == "Total") %>%
  mutate_at(vars(percent_1wk, percent_52wk),
            function(x) if_else(is.na(x), 0, x))

# Create levels vector
tw_levels <- this_week %>%
  arrange(desc(percent_1wk), basin) %>%
  .$basin

# Assign levels
this_week <- this_week %>%
  mutate(basin = factor(basin, levels = tw_levels))

# Weekly summary
summ <- rc_basin %>%
  group_by(key, Date) %>%
  summarize(value = sum(value, na.rm = TRUE))

##  Summarize rc_master
# Total rig count by `Year` and `Week`
diff <- total_comparison %>%
  group_by(Date, key) %>%
  summarize(value = sum(value, na.rm = TRUE)) %>%
  ungroup() %>%
  spread(key, value)
```

```{r print_diff}
diff %>%
  kable(format = "html") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE)

# print("total_comparison")
# total_comparison %>%
#   filter(Date == key_dates[["this_week"]]) %>%
#   select(basin:percent_1wk) %>%
#   kable(format = "html") %>%
#   kable_styling(bootstrap_options = c("striped", "hover"),
#                 full_width = FALSE)
```


```{r import_sf_data, include=FALSE}
load("states_48.RData")
load("sf_plays.RData")
load("text_mods.RData")
```


```{r wrangle_sf_data, include=FALSE}
##  Merge datasets with sf data
sf_plays_total <- sf_plays %>%
  merge(this_week, by.x = "Shale_play", by.y = "basin")

sf_type_comparison <- sf_plays %>%
  merge(type_comparison, by.x = "Shale_play", by.y = "basin")
```

```{r create_lines}
# Not all text labels can neatly fit next to their respective basins
line_barnett <- text_mods %>%
  filter(Shale_play == "Barnett")

line_barnett <- line_barnett[c(1, 1), ]

line_barnett$X[1] <- line_barnett$X[1] - 160000
line_barnett$Y[1] <- line_barnett$Y[1] + 20000
line_barnett$X[2] <- line_barnett$X[2] - 260000
line_barnett$Y[2] <- line_barnett$Y[2] + 170000

line_cana_woodford <- text_mods %>%
  filter(Shale_play == "Cana Woodford")

line_cana_woodford <- line_cana_woodford[c(1, 1), ]

line_cana_woodford$X[1] <- line_cana_woodford$X[1] + 300000
line_cana_woodford$Y[1] <- line_cana_woodford$Y[1] - 50000
line_cana_woodford$X[2] <- line_cana_woodford$X[2] + 450000
line_cana_woodford$Y[2] <- line_cana_woodford$Y[2] - 130000

```

<!-- Canvas and layouts -->

```{r plot_canvas}
# Create blank geom to hold plots
gb <- ggplot() +
  geom_blank() +
  theme(axis.title = element_blank()) +
  theme(plot.caption = element_text("Open Sans", colour = "gray30", size = 12))
```

```{r plot_map_layout}
map_layout <- ggplot() +
  geom_sf(data = states_48, fill = "white", color = "gray60") +
  geom_text(data = text_mods, aes(X, Y, label = Shale_play), size = 3) +
  geom_line(data = line_barnett, aes(X, Y), color = "black") +
  geom_line(data = line_cana_woodford, aes(X, Y), color = "black") +
  theme(axis.title = element_blank()) +
  theme(plot.caption = element_text("Open Sans", colour = "gray30", size = 12),
        legend.position = c(0.85, 0.08),
        legend.justification = c("left", "bottom"),
        legend.box.just = "right")
```

<!-- Rig count plots -->

```{r plot_rig_count_canvas}
rc_gb <- gb +
  labs(title    = paste0("Rigging up, rigging down"),
       subtitle = paste0("Where did rig counts change from the week of ",
                         key_dates[["week_ago"]], " to\n",
                         key_dates[["this_week"]], "?"),
       caption = paste0("Source: Baker Hughes Rig Count")) +
  theme(plot.caption = element_text(size = 10, color = "gray50"))
```

```{r plot_rig_count_map}
##  Map
wk1_changes <- this_week$percent_1wk %>%
  sign() %>%
  unique() %>%
  sort()

map_colors <- wk1_changes %>%
  as.character() %>%
  map_chr(~switch(.x,
                  "-1" = "#a52a2a",
                  "0"  = "gray50",
                  "1"  = "#4682b4"))

rc_map <- map_layout %+% sf_plays_total
rc_map <- rc_map  +
  geom_sf(aes(fill = factor(sign(percent_1wk))),
          color = "black",
          alpha = 0.9) +
  scale_fill_manual(name = NULL,
                    values = map_colors,
                    labels = c("Decrease", "No Change", "Increase")) +
  coord_sf(crs = st_crs(102003), datum = NA) +
  guides(color = FALSE)
```

```{r plot_rig_count_charts_week_ago}
# Colors for bar charts.
# Different than map colors since plays with 'no change'
# are removed from the bar charts.
total_wk1_colors <- wk1_changes %>%
  get_2_colors()

####  Change from week ago
# Percent change

  # Create levels vector
  percent_1wk_levels <- this_week %>%
    arrange(desc(percent_1wk), basin) %>%
    .$basin
    
  # Assign levels
  this_week <- this_week %>%
    mutate(basin = factor(basin, levels = percent_1wk_levels))

##  Bar chart: Percent change from week ago
rc_percent_1wk <- this_week %>%
  filter(percent_1wk != 0 & !is.infinite(percent_1wk)) %>%
  ggplot() +
  geom_col(aes(fct_rev(basin), percent_1wk, fill = percent_1wk > 0)) +
  coord_flip() +
  scale_fill_manual(values = total_wk1_colors) +
  scale_y_continuous(labels = blg_frmt_percent(0),
                     minor_breaks = NULL) +
  guides(fill = FALSE) +
  labs(title = "Percent change from\nprevious week",
       x = NULL,
       y = "") +
  blg_theme_default(12)

# Net change in value
total_wk1_colors <- this_week$percent_1wk %>%
  sign() %>%
  unique() %>%
  sort() %>%
  get_2_colors()

  # Create levels vector
  change_1wk_levels <- this_week %>%
    arrange(desc(change_1wk), basin) %>%
    .$basin
    
  # Assign levels
  this_week <- this_week %>%
    mutate(basin = factor(basin, levels = change_1wk_levels))

##  Bar chart: Net change in value from week ago
rc_change_1wk <- this_week %>%
  filter(change_1wk != 0 & !is.infinite(percent_1wk)) %>%
  ggplot() +
  geom_col(aes(fct_rev(basin), change_1wk, fill = change_1wk > 0)) +
  coord_flip() +
  scale_fill_manual(values = total_wk1_colors) +
  scale_y_continuous(minor_breaks = NULL) +
  guides(fill = FALSE) +
  labs(title = "Net change from\nprevious week",
       x = NULL,
       y = "") +
  blg_theme_default(12)
```

```{r plot_rig_count_charts_year_ago}
####  Change from year ago
# Color setup
wk52_colors <- this_week$percent_52wk %>%
  sign() %>%
  unique()

wk52_colors <- switch(as.character(sum(wk52_colors) + 2),
                      "1" = "#a52a2a", # when only negative change
                      "2" = c("#4682b4", "#a52a2a"), # when both
                      "3" = "#4682b4") # when only positive change

# Percent change
  # Create levels vector
  percent_52wk_levels <- this_week %>%
    arrange(desc(percent_52wk), basin) %>%
    .$basin
  
  # Assign levels
  this_week <- this_week %>%
    mutate(basin = factor(basin, levels = percent_52wk_levels))

  
##  BAR - Rig count; 52 week percent change
rc_percent_52wk <- this_week %>%
  filter(percent_52wk != 0 & !is.infinite(percent_52wk)) %>%
  ggplot() +
  geom_col(aes(fct_rev(basin), percent_52wk, fill = percent_52wk < 0)) +
  coord_flip() +
  scale_fill_manual(values = wk52_colors) +
  scale_y_continuous(labels = blg_frmt_percent(0)) +
  guides(fill = FALSE) +
  labs(title = "Percent change from\nprevious year",
       x = NULL,
       y = "") +
  blg_theme_default(12)


# Net change
  # Create levels vector
  change_52wk_levels <- this_week %>%
    arrange(desc(change_52wk), basin) %>%
    .$basin
  
  # Assign levels
  this_week <- this_week %>%
    mutate(basin = factor(basin, levels = change_52wk_levels))

##  BAR - Rig count; 52 week percent change
rc_change_52wk <- this_week %>%
  filter(change_52wk != 0 & !is.infinite(change_52wk)) %>%
  ggplot() +
  geom_col(aes(fct_rev(basin), change_52wk, fill = change_52wk < 0)) +
  coord_flip() +
  scale_fill_manual(values = wk52_colors) +
  scale_y_continuous(minor_breaks = NULL) +
  guides(fill = FALSE) +
  labs(title = "Net change from\nprevious year",
       x = NULL,
       y = "") +
  blg_theme_default(12)
```

```{r plot_rig_count_build}
##  GROBS
rc_grobs <- arrangeGrob(rc_map,
                        rc_change_1wk,  rc_change_52wk,
                        rc_percent_1wk, rc_percent_52wk,
                        layout_matrix = rbind(c(1, 1),
                                              c(2, 3),
                                              c(4, 5)))

rc_gb_grob <- ggplotGrob(rc_gb)
rc_gb_grob$grobs[[which(rc_gb_grob$layout$name == "panel")]] <- rc_gb_grob$grobs[[which(rc_gb_grob$layout$name == "panel")]] %>%
  addGrob(rc_grobs)
```

```{r plot_rig_count_draw, fig.height=13}
grid.draw(rc_gb_grob)
```

<!-- Rig type plots -->

```{r plot_rig_type_canvas}
##  LAYOUT - Rig type
rt_gb <- gb +
  labs(title = "Focal point",
       subtitle = paste0("Which resource are rigs after for the week of ",
                         key_dates[["this_week"]], "?"),
       caption = paste0("Source: Baker Hughes Rig Count")) +
  theme(plot.caption = element_text(size = 10, color = "gray50"))
```

```{r plot_rig_type_chart}
##  LINE - Rig type
summ_text <- summ %>%
    ungroup() %>%
    filter(key != "Misc") %>%
    mutate(Date = as.Date(Date)) %>%
    group_by(key) %>%
    arrange(desc(Date)) %>%
    filter(row_number() == 1) %>%
    ungroup() %>%
    mutate(label_key = stri_pad_right(key, max(stri_length(key))),
           label_value = stri_pad_right(paste0("(", comma(value), ")"),
                                        max(stri_length(paste0("(", comma(value), ")")))),
           label = paste0(label_key, "\n", label_value))

# Labels
summ_text <- summ_text %>%
  mutate(x = Date + 100,
         y = case_when(
           key == "Total" ~ value + 20,
           key == "Oil"   ~ value - 110,
           key == "Gas"   ~ value + 15
         ))

rt_type <- summ %>%
  filter(key != "Misc") %>%
  mutate(Date = as.Date(Date)) %>%
  ggplot() +
  geom_line(aes(Date, value, color = key), size = 0.7) +
  geom_label(aes(x, y, group = key, fill = key, label = label),
            filter(summ_text, key == "Total"), color = "white") +
  geom_label(aes(x, y, group = key, fill = key, label = label),
            filter(summ_text, key != "Total"), color = "black") +
  scale_y_continuous(labels = comma) +
  scale_color_manual(values = c(yellow, blue, "black")) +
  scale_fill_manual(values = c(yellow, blue, "black")) +
  guides(color = FALSE,
         fill  = FALSE) +
  labs(title = "Rig count by well type",
       y = "Rig count") +
  blg_theme_default(12)
```

```{r plot_total_chart_build}
##  BAR - Total current rig total
rc_total <- total_comparison %>%
  filter(Date == max(Date) & key %in% c("Oil", "Gas", "Total")) %>%
  select(basin:value) %>%
  spread(key, value) %>%
  gather(... = c(Gas, Oil)) %>%
  arrange(Total, basin)

rc_total$basin <- factor(rc_total$basin, levels = unique(rc_total$basin))

rc_total_chart <- rc_total %>%
  ggplot() +
  geom_col(aes(basin, value, fill = key)) +
  scale_fill_manual("Rig type", values = c(yellow, blue)) +
  labs(x = NULL,
       y = paste0("Rig Count")) +
  # guides(fill = guide_legend(label.position = "bottom", title.vjust = 1)) +
  guides(fill = FALSE) +
  blg_theme_default(12) +
  theme(panel.grid.major.y = element_blank()#,
        # legend.position = "top",
        # legend.direction = "horizontal",
        # legend.justification = "left"
        ) +
  coord_flip()
```

```{r plot_rig_type_map}
##  MAP - Rig type
rt_map <- map_layout %+% sf_type_comparison
rt_map <- rt_map +
  geom_sf(aes(fill = prcnt_oil),
          color = "black",
          alpha = 0.9) +
  scale_fill_gradient2(name = NULL,
                       low = yellow, high = blue,
                       mid = "#F5F5F5", midpoint = 0.5,
                       na.value = "gray50",
                       labels = c("100% Gas", "",
                                  "Split",    "",
                                  "100% Oil")) +
  coord_sf(crs = st_crs(102003), datum = NA)
```

```{r plot_rig_type_build}
rt_gb_grob <- ggplotGrob(rt_gb)

rt_grobs <- arrangeGrob(rt_map, rt_type, rc_total_chart,
                        layout_matrix = rbind(c(2, 2),
                                              c(1, 1),
                                              c(3, 3)))

rt_gb_grob$grobs[[which(rt_gb_grob$layout$name == "panel")]] <- rt_gb_grob$grobs[[which(rt_gb_grob$layout$name == "panel")]] %>%
  addGrob(rt_grobs)
```

```{r plot_rig_type_draw, fig.height=13}
# old fig.height=9.2
grid.draw(rt_gb_grob)
```

<!-- Rig type other plots -->

```{r plot_rig_type_other_canvas}
##  LAYOUT - Rig type
rto_gb <- gb +
  labs(title = paste0("Which resource are drillers after and how is it changing?"),
       subtitle = paste0("Week of: ",
                         key_dates[["this_week"]], "?"),
       caption = paste0("Source: Baker Hughes Rig Count")) +
  theme(plot.caption = element_text(size = 10, color = "gray50"))
```

```{r plot_percent_rig_type}
##  Percent change - Oil
oil_dat <- total_comparison %>%
  filter(key == "Oil" & Date == max(Date) & percent_1wk != 0)

oil_wk1_colors <- oil_dat$percent_1wk %>%
  sign() %>%
  unique() %>%
  get_2_colors()

bc_oil_percent_1wk <- oil_dat %>%
  ggplot() +
  geom_col(aes(reorder(basin, percent_1wk, identity), percent_1wk, fill = TRUE)) +
  scale_y_continuous(minor_breaks = NULL, labels = blg_frmt_percent()) +
  scale_fill_manual(values = blue) +
  guides(fill = FALSE) +
  coord_flip() +
  blg_theme_default(12) +
  theme(axis.title = element_blank())

##  Percent change - Gas
gas_dat <- total_comparison %>%
  filter(key == "Gas" & Date == max(Date) & percent_1wk != 0)

gas_wk1_colors <- gas_dat$percent_1wk %>%
  sign() %>%
  unique() %>%
  get_2_colors()

bc_gas_percent_1wk <- bc_oil_percent_1wk %+%
  gas_dat +
  scale_fill_manual(values = yellow)
```

```{r plot_net_change_rig_type}
##  Percent change - Oil
oil_dat <- total_comparison %>%
  filter(key == "Oil" & Date == max(Date) & change_1wk != 0)

oil_wk1_colors <- oil_dat$change_1wk %>%
  sign() %>%
  unique() %>%
  get_2_colors()

bc_oil_change_1wk <- oil_dat %>%
  ggplot() +
  geom_col(aes(reorder(basin, change_1wk, identity), change_1wk, fill = TRUE)) +
  scale_y_continuous(minor_breaks = NULL) +
  scale_fill_manual(values = blue) +
  guides(fill = FALSE) +
  coord_flip() +
  blg_theme_default(12) +
  theme(axis.title = element_blank())

##  Percent change - Gas
gas_dat <- total_comparison %>%
  filter(key == "Gas" & Date == max(Date) & change_1wk != 0)

gas_wk1_colors <- gas_dat$change_1wk %>%
  sign() %>%
  unique() %>%
  get_2_colors()

bc_gas_change_1wk <- bc_oil_change_1wk %+%
  gas_dat +
  scale_fill_manual(values = yellow)
```

```{r plot_rig_type_other_build}
rto_gb_grob <- ggplotGrob(rto_gb)

rto_grobs <- arrangeGrob(rc_total_chart,
                         bc_gas_percent_1wk, bc_oil_percent_1wk,
                         bc_gas_change_1wk,  bc_oil_change_1wk,
                         layout_matrix = rbind(c(1, 1),
                                               c(1, 1),
                                               c(2, 3),
                                               c(4, 5)))

rto_gb_grob$grobs[[which(rto_gb_grob$layout$name == "panel")]] <- rto_gb_grob$grobs[[which(rto_gb_grob$layout$name == "panel")]] %>%
  addGrob(rto_grobs)
```

```{r plot_rig_type_other_draw, fig.height=9.2}
grid.draw(rto_gb_grob)
```

```{r plot_misc}
x <- map(unique(rc_basin$basin), ~{
    rc_basin %>%
        filter(basin == .x & key == "Total") %>%
        mutate(change = value - lag(value, 1L)) %>%
        filter(!is.na(change)) %>%
        filter(change < 1) %>%
        filter(lubridate::year(Date) == 2017L)
           }) %>%
  map_int(nrow)

y <- tibble(Basin = unique(rc_basin$basin), Weeks = x)

y %>%
    arrange(Weeks) %>%
    mutate(Basin = factor(Basin, levels = rev(Basin))) %>%
    ggplot() +
    geom_col(aes(Basin, Weeks, fill = Weeks)) +
    geom_text(aes(Basin, Weeks, label = Weeks), nudge_y = 1.7) +
    coord_flip() +
    guides(fill = FALSE) +
    labs(title = "Top Performers",
         subtitle = paste0("Which basins have had the fewest", "\nno-growth weeks during 2017?"),
         x = NULL)
```

```{r d3_csv, include=FALSE}
this_week <- mutate(this_week, basin = if_else(basin == "Others", "Other US Basins", as.character(basin)))
netCount <- this_week %>% select(basin, value)
netChange <- this_week %>% select(basin, change_1wk)

write_csv(netCount, "~/D3/rc_map/netCount.csv")
write_csv(netChange, "~/D3/rc_map/netChange.csv")
```

```{r cleanup, include=FALSE}
rm(list = ls(pattern = "api_key_"))
```
