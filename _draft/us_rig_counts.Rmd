---
title  : "US Rig Counts"
author : "Luke Smith"
date   : "2017-10-06"
tags   : [r, oil, gas, oil and gas, rig counts]
description: ""
twitter :
  card    : "summary_large_image"
  site    : "@lksmth"
  creator : "@lksmth"
  title   : "US Rig Counts"
  description : ""
  image       : ""
og :
  image : ""
---

```{r setup_std, include=FALSE, purl=FALSE, eval=TRUE}
# ____ Library_Tidyverse_Setup
library(tidyverse)
library(lubridate)
library(forcats)
library(stringi)

# ____ Library_ploting_Setup
library(grid)
library(gridExtra)
library(ggExtra)
library(GGally)
library(ggalt)
library(scales)
library(extrafont)
loadfonts("win")

# ____ Library_Web_Setup
library(rvest)
library(jsonlite)

# ____ Library_Reporting_Setup
library(knitr)
library(kableExtra)

# ____ My_Blogging_Setup
library(blg)

# ____ Opts_Setup
knitr::opts_chunk$set(echo =  FALSE)
knitr::opts_chunk$set(fig.height = 7)
knitr::opts_chunk$set(message    = FALSE)
knitr::opts_chunk$set(warning    = FALSE)


# ____ R_Options_Setup
old_scipen <- getOption("scipen")
options(scipen = 100)

old_digits <- getOption("digits")
options(digits = 2)


# ____ knitr_Options_Setup
orig_inline <- knit_hooks$get("inline")
old_plot   <- knit_hooks$get("plot")


# ____ Hooks_Setup

knit_hooks$set(inline = function(x) {
  if (is.numeric(x) | is.integer(x)) return(formatC(x, format = "d", big.mark = ",")) else
    if (is.character(x)) return(stringr::str_to_title(x)) else
      return(x)
})

old_inline <- knit_hooks$get("inline")

my_blue   <- "#0059B3"
my_orange <- "#B35A00"
my_pink   <- "#B30059"
my_green  <- "#59B300"
```

```{r setup_extra, include=FALSE}
library(sf)
library(forcats)
library(httr)
library(curl)
library(zeallot)
library(kableExtra)

library(magick)
library(tweenr)

theme_set(blg_theme_default())
ref <- "~/R/misc/oil/US/rig_counts"
```

<!-- Rig count notes -->

```{r notes_rig_count, include=FALSE, eval=FALSE}
# Earliest splits by:
#   * Basin      = 2011
#   * State      = 2000
#   * Oil & Gas  = 1987
#   * Trajectory = 1991
#   * GOM        = 2000
#   * Canada (Province)  = 2003
#   * Canada (Oil & Gas) = 2000

# Basin names in rig counts:
# Order        Basin_Name
#     1  Ardmore Woodford
#     2   Arkoma Woodford
#     3           Barnett
#     4     Cana Woodford
#     5       DJ-Niobrara
#     6        Eagle Ford
#     7      Fayetteville
#     8      Granite Wash
#     9       Haynesville
#    10         Marcellus
#    11     Mississippian
#    12           Permian
#    13             Utica
#    14         Williston
#    15            Others
#    16 Total US RigCount
```

```{r load_data, include=FALSE, purl=TRUE}
ref <- "~/R/misc/oil/US/rig_counts"
load(file.path(ref, "rc_basin.RData"))
load(file.path(ref, "rc_master.RData"))
```

```{r analyze_data_rig_counts, include=FALSE}
nms <- c("this_week", "week_ago",
         "month_ago", "six_months_ago",
         "year_ago")

key_dates <- rc_basin$Date %>%
  unique() %>%
  sort(decreasing = TRUE) %>%
  .[c(1, 2, 5, 27, 53)] %>%
  set_names(nms)

# Find most recent week's change from previous week; Total
total_comparison <- rc_basin %>%
  group_by(basin, key) %>%
  arrange(Date) %>%
  mutate(change_1wk   = value - lag(value, 1L),
         percent_1wk  = change_1wk / lag(value),
         change_4wk   = value - lag(value, 4L),
         percent_4wk  = change_4wk / lag(value, 4),
         change_16wk  = value - lag(value, 16L),
         percent_16wk = change_16wk / lag(value, 16),
         change_52wk  = value - lag(value, 52L),
         percent_52wk = change_52wk / lag(value, 52)) %>%
  ungroup() %>%
  filter(Date %in% c(key_dates[c("this_week", "week_ago")]))

# Find most recent week's oil and gas type
type_comparison <- total_comparison %>%
  filter(Date == max(Date)) %>%
  filter(key %in% c("Gas", "Oil")) %>%
  select(basin:value) %>%
  spread(key, value) %>%
  mutate(prcnt_oil = Oil / (Oil + Gas))

# Get totals and just the current week.
# Remove NaN's and NA's for plotting purposes.
this_week <- total_comparison %>%
  filter(Date == key_dates[["this_week"]]) %>%
  filter(key == "Total") %>%
  mutate_at(vars(percent_1wk, percent_52wk),
            function(x) if_else(is.na(x), 0, x))

# Create levels vector
tw_levels <- this_week %>%
  arrange(desc(percent_1wk), basin) %>%
  .$basin

# Assign levels
this_week <- this_week %>%
  mutate(basin = factor(basin, levels = tw_levels))

# Weekly summary
summ <- rc_basin %>%
  group_by(key, Date) %>%
  summarize(value = sum(value, na.rm = TRUE))

##  Summarize rc_master
# Total rig count by `Year` and `Week`
diff <- total_comparison %>%
  group_by(Date, key) %>%
  summarize(value = sum(value, na.rm = TRUE)) %>%
  ungroup() %>%
  spread(key, value)
```

```{r print_diff}
diff %>%
  kable(format = "html") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE)

print("total_comparison")
total_comparison %>%
  filter(Date == key_dates[["this_week"]]) %>%
  select(basin:percent_1wk) %>%
  kable(format = "html") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE)
```


```{r import_sf_data, include=FALSE}
sf_plays_orig <- st_read("~/R/misc/oil/US/eia_shape/TightOil_ShaleGas_Plays_Lower48_EIA/TightOil_ShalePlays_US_EIA_May2016.shp")

sf_basins <- st_read("~/R/misc/oil/US/eia_shape/SedimentaryBasins_US_EIA/SedimentaryBasins_US_May2011_v2.shp")

load("~/R/misc/maps/states_map.RData")
```

```{r import_drawn_mapedit_data, include=FALSE}
# These two had to be "hand-drawn" using the mapedit package

granite_wash <- structure(list(Basin = "Granite Wash", feature_type = "polygon", 
    geometry = structure(list(structure(list(structure(c(-99.9976, 
    -100.2063, -100.3436, -100.5469, -100.6787, -100.8435, -100.8545, 
    -100.8215, -100.6787, -100.5029, -100.3079, -100.1129, -99.7229, 
    -99.4263, -99.2725, -99.1296, -99.0088, -98.9978, -99.1516, 
    -99.3823, -99.4592, -99.5581, -99.7339, -99.9976, 35.7733, 
    35.8623, 35.9202, 36.0313, 36.0757, 36.0846, 35.9869, 35.9157, 
    35.8089, 35.6751, 35.5412, 35.407, 35.1379, 35.021, 34.976, 
    34.976, 34.976, 35.084, 35.1828, 35.2815, 35.3532, 35.4338, 
    35.5859, 35.7733), .Dim = c(24L, 2L))), class = c("XY", "POLYGON", 
    "sfg"))), n_empty = 0L, precision = 0, class = c("sfc_POLYGON", 
    "sfc"), bbox = structure(c(-100.8545, 34.976, -98.9978, 36.0846
    ), .Names = c("xmin", "ymin", "xmax", "ymax"), class = "bbox"), crs = structure(list(
        epsg = 4326L, proj4string = "+proj=longlat +datum=WGS84 +no_defs"), .Names = c("epsg", 
    "proj4string"), class = "crs")), Lithology = NA, Shale_play = "Granite Wash", 
    Source = "Hand Drawn", Area_sq_mi = NA, Area_sq_km = NA, 
    Age_shale = NA), row.names = c(NA, -1L), class = c("sf", 
"data.frame"), sf_column = "geometry", agr = structure(c(NA_integer_, 
NA_integer_), class = "factor", .Label = c("constant", "aggregate", 
"identity"), .Names = c("Basin", "feature_type")), .Names = c("Basin", 
"feature_type", "geometry", "Lithology", "Shale_play", "Source", 
"Area_sq_mi", "Area_sq_km", "Age_shale"))

mississippian <- structure(list(Basin = "Mississippian", feature_type = "polygon", 
    geometry = structure(list(structure(list(structure(c(-98.5474, 
    -99.0747, -99.4263, -99.5142, -99.2285, -98.6572, -97.4268, 
    -96.5918, -96.1523, -95.8887, -95.6909, -95.5151, -95.6909, 
    -96.1084, -97.0752, -97.7563, -98.5474, 36.3151, 36.4213, 
    36.6155, 37.0201, 37.2653, 37.3178, 37.4225, 37.3352, 37.1778, 
    37.1078, 36.9499, 36.6684, 36.3505, 36.2088, 36.2266, 36.2974, 
    36.3151), .Dim = c(17L, 2L))), class = c("XY", "POLYGON", 
    "sfg"))), n_empty = 0L, precision = 0, class = c("sfc_POLYGON", 
    "sfc"), bbox = structure(c(-99.5142, 36.2088, -95.5151, 37.4225
    ), .Names = c("xmin", "ymin", "xmax", "ymax"), class = "bbox"), crs = structure(list(
        epsg = 4326L, proj4string = "+proj=longlat +datum=WGS84 +no_defs"), .Names = c("epsg", 
    "proj4string"), class = "crs")), Lithology = NA, Shale_play = "Mississippian", 
    Source = "Hand Drawn", Area_sq_mi = NA, Area_sq_km = NA, 
    Age_shale = NA), row.names = c(NA, -1L), class = c("sf", 
"data.frame"), sf_column = "geometry", agr = structure(c(NA_integer_, 
NA_integer_), class = "factor", .Label = c("constant", "aggregate", 
"identity"), .Names = c("Basin", "feature_type")), .Names = c("Basin", 
"feature_type", "geometry", "Lithology", "Shale_play", "Source", 
"Area_sq_mi", "Area_sq_km", "Age_shale"))
```


```{r wrangle_sf_data, include=FALSE}
# Keep only 48 states (no lakes)
states_48 <- states_map %>%
  filter(NAME %in% c(state.name, "District of Columbia")) %>%
  filter(!(NAME %in% c("Alaska", "Hawaii"))) %>%
  filter(TYPE != "Water")

# Gather the plays that we need
sf_plays <- sf_plays_orig %>%
  filter(Shale_play != "Heath") %>%
  mutate(Shale_play = case_when(
    Basin == "Ardmore"  ~ "Ardmore Woodford",
    Basin == "Arkoma" & Shale_play != "Fayetteville"  ~ "Arkoma Woodford",
    Basin == "Anadarko" ~ "Cana Woodford",
    Basin == "Williston" ~ "Williston",
    Basin == "Permian" ~ "Permian",
    Basin == "Denver Basin" ~ "DJ-Niobrara",
    Basin == "TX-LA-MS Salt Basin" ~ "Haynesville",
    TRUE ~ as.character(Shale_play)
    ))

# Cast 'hand-drawn' polygons to multipolygon
granite_wash <- granite_wash %>%
  select(-feature_type) %>%
  st_cast("MULTIPOLYGON")
mississippian <- mississippian %>%
  select(-feature_type) %>%
  st_cast("MULTIPOLYGON")

# Add the above two to the main table
sf_plays <- sf_plays %>%
  rbind(granite_wash) %>%
  rbind(mississippian) %>%
  filter(Shale_play %in% this_week$basin)

##  Merge MULTIPOLYGONS
# Separate dupes from non-dupes
grouped_sf_plays <- sf_plays %>% group_by(Shale_play)

dupes <- grouped_sf_plays %>%
  filter(n() > 1)

no_dupes  <- grouped_sf_plays %>%
  filter(n() == 1)

# Split and union (i.e. dissolve/merge) multi's
new_dupe_geometry <- dupes %>%
  split(.$Shale_play) %>%
  map(~st_cast(st_sf(st_union(.x)), "MULTIPOLYGON")) %>%
  reduce(rbind) %>%
  st_geometry()

# Splice of some rows and add the new dissolved geometry
dupes <- dupes %>%
  slice(c(1, nrow(.))) %>%
  st_set_geometry(new_dupe_geometry)

# Add the two together again
sf_plays <- no_dupes %>%
  rbind(dupes)

##  Create text table for `geom_text()`
# Find centroid of each feature to use as (x, y) for text
sf_text <- sf_plays %>%
  st_centroid()

# Extract coordinates (to use with geom_point())
sf_text <- sf_text %>%
  st_coordinates() %>%
  cbind(as_tibble(sf_text), .) %>%
  as_tibble()

text_mods <- sf_text %>%
  cbind(tibble(offset_X = c( 5.8,  1.8, # Ardmore,      Fayetteville
                             4.3,  5.4, # Barnett,      Arkoma
                            -5.8,  2.0, # Cana,         Haynesville
                            -4.6,       # Eagle Ford
                            -4.5, -5.7, # DJ-Niobrara, Marcellus
                            -5.4, -4.2, # Utica, Granite Wash
                             0.0, -3.8, # Mississippian, Permian
                            -3.7))) %>% # Williston
  cbind(tibble(offset_Y = c(-0.9,  0.9, # Ardmore,      Fayetteville
                            -1.0, -0.5, # Barnett,      Arkoma
                             1.3,  0.0, # Cana,  Haynesville
                            -0.7,       # Eagle Ford
                            -1.0, -2.7, # DJ-Niobrara, Marcellus
                             0.0,  0.0, # Utica, Granite Wash
                             1.5,  1.0, # Mississippian, Permian
                            -1.0))) %>% # Williston
  mutate(new_X = X + offset_X,
         new_Y = Y + offset_Y)

text_mods <- text_mods %>%
    mutate(new_X = new_X + offset_X,
           new_Y = new_Y + offset_Y,

           new_X = case_when(
             Shale_play == "Ardmore Woodford" ~ new_X * 1.072, #$ + pos
             Shale_play == "Fayetteville" ~ new_X * 1.03,      #$ + pos
             Shale_play == "Barnett" ~ new_X * 1.05,           #$ + pos
             Shale_play == "Arkoma Woodford" ~ new_X * 1.07,   #$ + pos
             Shale_play == "Cana Woodford" ~ new_X * 0.95,     #$ - neg
             Shale_play == "Haynesville"   ~ new_X * 1.00,
             Shale_play == "Eagle Ford" ~ new_X * 0.955,       #$ - neg
             Shale_play == "DJ-Niobrara" ~ new_X * 0.96,       #$ - neg
             Shale_play == "Marcellus" ~ new_X * 0.94,         #$ - neg
             Shale_play == "Utica" ~ new_X * 0.935,            #$ - neg
             Shale_play == "Granite Wash" ~ new_X * 0.96,      #$ - neg
             Shale_play == "Mississippian" ~ new_X * 1.00,     #$ 0
             Shale_play == "Permian" ~ new_X * 0.9675,         #$ - neg
             Shale_play == "Williston" ~ new_X * 0.985         #$ - neg
             ),
           new_Y = case_when(
             Shale_play == "Ardmore Woodford" ~ new_Y * 1.038, #$ - neg
             Shale_play == "Fayetteville" ~ new_Y * 0.975,     #$ + pos
             Shale_play == "Barnett" ~ new_Y * 1.00,           #$ - neg
             Shale_play == "Arkoma Woodford" ~ new_Y * 1.02,   #$ - neg
             Shale_play == "Cana Woodford" ~ new_Y * 0.97,     #$ + pos
             Shale_play == "Haynesville"   ~ new_Y * 1.00,
             Shale_play == "Eagle Ford" ~ new_Y * 1.035,       #$ - neg
             Shale_play == "DJ-Niobrara" ~ new_Y * 1.04,       #$ - neg
             Shale_play == "Marcellus" ~ new_Y * 1.079,        #$ - neg
             Shale_play == "Utica" ~ new_Y * 1.00,             #$ 0
             Shale_play == "Granite Wash" ~ new_Y * 1.00,      #$ 0
             Shale_play == "Mississippian" ~ new_Y * 0.96,     #$ + pos
             Shale_play == "Permian" ~ new_Y * 0.95,           #$ 0
             Shale_play == "Williston" ~ new_Y * 1.05          #$ - neg
             )) %>%
    st_as_sf(coords = c("new_X", "new_Y"), crs = 4326, agr = "identity") %>%
    st_transform(102003)

text_mods <- text_mods %>%
    select(-(X:Y)) %>%
    st_coordinates() %>%
    cbind(as_tibble(text_mods %>% select(-(X:Y))), .)

##  Merge datasets with sf data
sf_plays_total <- sf_plays %>%
  merge(this_week, by.x = "Shale_play", by.y = "basin")

sf_type_comparison <- sf_plays %>%
  merge(type_comparison, by.x = "Shale_play", by.y = "basin")
```

```{r create_lines}
# Not all text labels can neatly fit next to their respective basins
line_barnett <- text_mods %>%
  filter(Shale_play == "Barnett")

line_barnett <- line_barnett[c(1, 1), ]

line_barnett$X[1] <- line_barnett$X[1] - 160000
line_barnett$Y[1] <- line_barnett$Y[1] + 20000
line_barnett$X[2] <- line_barnett$X[2] - 260000
line_barnett$Y[2] <- line_barnett$Y[2] + 170000

line_cana_woodford <- text_mods %>%
  filter(Shale_play == "Cana Woodford")

line_cana_woodford <- line_cana_woodford[c(1, 1), ]

line_cana_woodford$X[1] <- line_cana_woodford$X[1] + 300000
line_cana_woodford$Y[1] <- line_cana_woodford$Y[1] - 50000
line_cana_woodford$X[2] <- line_cana_woodford$X[2] + 450000
line_cana_woodford$Y[2] <- line_cana_woodford$Y[2] - 130000

```

<!-- Canvas and layouts -->

```{r plot_canvas}
# Create blank geom to hold plots
gb <- ggplot() +
  geom_blank() +
  theme(axis.title = element_blank()) +
  theme(plot.caption = element_text("Open Sans", colour = "gray30", size = 12))
```

```{r plot_map_layout}
map_layout <- ggplot() +
  geom_sf(data = states_48, fill = "white", color = "gray60") +
  geom_text(data = text_mods, aes(X, Y, label = Shale_play), size = 3) +
  geom_line(data = line_barnett, aes(X, Y), color = "black") +
  geom_line(data = line_cana_woodford, aes(X, Y), color = "black") +
  theme(axis.title = element_blank()) +
  theme(plot.caption = element_text("Open Sans", colour = "gray30", size = 12),
        legend.position = c(0.85, 0.08),
        legend.justification = c("left", "bottom"),
        legend.box.just = "right")
```

<!-- Rig count plots -->

```{r plot_rig_count_canvas}
rc_gb <- gb +
  labs(title    = paste0("Rigging up, rigging down"),
       subtitle = paste0("Where did rig counts change from the week of ",
                         key_dates[["week_ago"]], " to\n",
                         key_dates[["this_week"]], "?"))
```

```{r plot_rig_count_map}
##  Map
wk1_colors <- this_week$percent_1wk %>%
  sign() %>%
  unique()

map_colors <- switch(as.character(sum(wk1_colors + c(2, 4, 6))),
       "2" = clrs$red,
       "3" = "gray50",
       "5" = c(clrs$red, "gray50"),
       "7" = clrs$blue,
       "9" = c(clrs$red, clrs$blue),
       "10" = c("gray50", clrs$blue),
       "12" = c(clrs$red, "gray50", clrs$blue))

rc_map <- map_layout %+% sf_plays_total
rc_map <- rc_map  +
  geom_sf(aes(fill = factor(sign(percent_1wk))),
          color = "black",
          alpha = 0.9) +
  scale_fill_manual(name = NULL,
                    values = map_colors,
                    labels = c("Decrease", "No Change", "Increase")) +
  coord_sf(crs = st_crs(102003), datum = NA) +
  guides(color = FALSE)
```

```{r plot_rig_count_charts}
# Colors for bar charts.
# Different than map colors since plays with 'no change'
# are removed from the bar charts.
wk1_colors <- switch(as.character(sum(wk1_colors) + 2),
                    "1" =  clrs$red, # when only negative change
                    "2" =  c(clrs$blue, clrs$red), # when both
                    "3" =  clrs$blue) # when only positive change

####  Change from week ago
# Percent change

  # Create levels vector
  percent_1wk_levels <- this_week %>%
    arrange(desc(percent_1wk), basin) %>%
    .$basin
    
  # Assign levels
  this_week <- this_week %>%
    mutate(basin = factor(basin, levels = percent_1wk_levels))

##  Bar chart: Percent change from week ago
rc_percent_1wk <- this_week %>%
  filter(percent_1wk != 0 & !is.infinite(percent_52wk)) %>%
  ggplot() +
  geom_col(aes(fct_rev(basin), percent_1wk, fill = percent_1wk < 0)) +
  coord_flip() +
  scale_fill_manual(values = wk1_colors) +
  scale_y_continuous(labels = blg_frmt_percent(0),
                     minor_breaks = NULL) +
  guides(fill = FALSE) +
  labs(title = "Percent change from\nprevious week",
       x = NULL,
       y = NULL) +
  blg_theme_default(12)

# Net change in value

  # Create levels vector
  change_1wk_levels <- this_week %>%
    arrange(desc(change_1wk), basin) %>%
    .$basin
    
  # Assign levels
  this_week <- this_week %>%
    mutate(basin = factor(basin, levels = change_1wk_levels))

##  Bar chart: Net change in value from week ago
rc_change_1wk <- this_week %>%
  filter(change_1wk != 0 & !is.infinite(percent_52wk)) %>%
  ggplot() +
  geom_col(aes(fct_rev(basin), change_1wk, fill = change_1wk < 0)) +
  coord_flip() +
  scale_fill_manual(values = wk1_colors) +
  scale_y_continuous(minor_breaks = NULL) +
  guides(fill = FALSE) +
  labs(title = "\nNet change from\nprevious week",
       x = NULL,
       y = NULL) +
  blg_theme_default(12)


####  Change from year ago
# Color setup
wk52_colors <- this_week$percent_52wk %>%
  sign() %>%
  unique()

wk52_colors <- switch(as.character(sum(wk52_colors) + 2),
                      "1" = clrs$red, # when only negative change
                      "2" = c(clrs$blue, clrs$red), # when both
                      "3" = clrs$blue) # when only positive change

# Percent change
  # Create levels vector
  percent_52wk_levels <- this_week %>%
    arrange(desc(percent_52wk), basin) %>%
    .$basin
  
  # Assign levels
  this_week <- this_week %>%
    mutate(basin = factor(basin, levels = percent_52wk_levels))

  
##  BAR - Rig count; 52 week percent change
rc_percent_52wk <- this_week %>%
  filter(percent_52wk != 0 & !is.infinite(percent_52wk)) %>%
  ggplot() +
  geom_col(aes(fct_rev(basin), percent_52wk, fill = percent_52wk < 0)) +
  coord_flip() +
  scale_fill_manual(values = wk52_colors) +
  scale_y_continuous(labels = blg_frmt_percent(0)) +
  guides(fill = FALSE) +
  labs(title = "Percent change from\nprevious year",
       x = NULL,
       y = NULL) +
  blg_theme_default(12)


# Net change
  # Create levels vector
  change_52wk_levels <- this_week %>%
    arrange(desc(change_52wk), basin) %>%
    .$basin
  
  # Assign levels
  this_week <- this_week %>%
    mutate(basin = factor(basin, levels = change_52wk_levels))

##  BAR - Rig count; 52 week percent change
rc_change_52wk <- this_week %>%
  filter(change_52wk != 0 & !is.infinite(change_52wk)) %>%
  ggplot() +
  geom_col(aes(fct_rev(basin), change_52wk, fill = change_52wk < 0)) +
  coord_flip() +
  scale_fill_manual(values = wk52_colors) +
  scale_y_continuous(minor_breaks = NULL) +
  guides(fill = FALSE) +
  labs(title = "\nNet change from\nprevious year",
       x = NULL,
       y = NULL) +
  blg_theme_default(12)


##  BAR - Total current rig total
rc_total <- this_week %>%
  arrange(value) %>%
  mutate(basin = factor(basin, levels = basin)) %>%
  ggplot() +
  geom_col(aes(basin, value), fill = clrs$green) +
  labs(title = "\nTotal rig count",
       x = NULL,
       y = NULL) +
  blg_theme_default(12) +
  rotateTextX(30, vjust = 1)
```

```{r plot_rig_count_build}
##  GROBS
rc_grobs <- arrangeGrob(rc_map,
                        rc_percent_1wk, rc_percent_52wk,
                        rc_change_1wk,  rc_change_52wk,
                        layout_matrix = rbind(c(1, 1),
                                              c(2, 3),
                                              c(4, 5)))

rc_gb_grob <- ggplotGrob(rc_gb)
rc_gb_grob$grobs[[which(rc_gb_grob$layout$name == "panel")]] <- rc_gb_grob$grobs[[which(rc_gb_grob$layout$name == "panel")]] %>%
  addGrob(rc_grobs)
```

```{r plot_rig_count_draw, fig.height=14}
grid.draw(rc_gb_grob)
```

<!-- Rig type plots -->

```{r plot_rig_type_canvas}
##  LAYOUT - Rig type
rt_gb <- gb +
  labs(title = "Focal point",
       subtitle = paste0("Which resource are rigs after for the week of ",
                         key_dates[["this_week"]], "?"))
```

```{r plot_rig_type, fig.height=9.2}
##  LINE - Rig type
summ_text <- summ %>%
    ungroup() %>%
    filter(key != "Misc") %>%
    mutate(Date = as.Date(Date)) %>%
    group_by(key) %>%
    arrange(desc(Date)) %>%
    filter(row_number() == 1) %>%
    ungroup() %>%
    mutate(label_key = stri_pad_right(key, max(stri_length(key))),
           label_value = stri_pad_right(paste0("(", comma(value), ")"),
                                        max(stri_length(paste0("(", comma(value), ")")))),
           label = paste0(label_key, "\n", label_value))

summ_text <- summ_text %>%
  mutate(x = Date + 100,
         y = case_when(
           key == "Total" ~ value + 20,
           key == "Oil"   ~ value - 110,
           key == "Gas"   ~ value + 15
         ))

# summ_text$x <- summ_text$Date + 100
# summ_text$y <- summ_text$value + c(10, -50, 50)

rt_type <- summ %>%
  filter(key != "Misc") %>%
  mutate(Date = as.Date(Date)) %>%
  ggplot() +
  geom_line(aes(Date, value, color = key), size = 0.7) +
  geom_text(aes(x, y, group = key, color = key, label = label),
            summ_text) +
  scale_y_continuous(labels = comma) +
  scale_color_manual(values = c(
    # "#004A94",
    "#01665E",
    # "#940100",
    "#8C510A",
    "black")) +
  guides(color = FALSE) +
  labs(title = "Rig count by well type",
       y = "Rig count") +
  blg_theme_default(12)

##  MAP - Rig type
rt_map <- map_layout %+% sf_type_comparison
rt_map <- rt_map +
  geom_sf(aes(fill = prcnt_oil),
          color = "black",
          alpha = 0.9) +
  scale_fill_gradient2(name = NULL,
                       # low = "#004A94", high = "#940100",
                       low = "#01665E", high = "#8C510A",
                       mid = "#F5F5F5", midpoint = 0.5,
                       na.value = "gray50",
                       labels = c("100% Gas", "",
                                  "Split",    "",
                                  "100% Oil")) +
  coord_sf(crs = st_crs(102003), datum = NA)

rt_gb_grob <- ggplotGrob(rt_gb)

rt_grobs <- arrangeGrob(rt_map, rt_type, layout_matrix = rbind(c(2, 2),
                                                               c(1, 1)))

rt_gb_grob$grobs[[which(rt_gb_grob$layout$name == "panel")]] <- rt_gb_grob$grobs[[which(rt_gb_grob$layout$name == "panel")]] %>%
  addGrob(rt_grobs)

grid.draw(rt_gb_grob)
```


```{r cleanup, include=FALSE}
rm(list = ls(pattern = "api_key_"))
```
